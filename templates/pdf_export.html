<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Exporter un QCM PDF · ExBoot Laboratory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg-primary: radial-gradient(circle at 20% 20%, rgba(76,201,240,0.15), transparent 55%),
                     radial-gradient(circle at 80% 30%, rgba(244,114,182,0.18), transparent 60%),
                     radial-gradient(circle at 50% 80%, rgba(16,185,129,0.22), transparent 65%),
                     #040711;
      --glass: rgba(10, 14, 24, 0.72);
      --border: rgba(148, 163, 184, 0.22);
      --accent: #47f5c0;
      --text-primary: #f8fafc;
      --text-muted: rgba(226, 232, 240, 0.72);
      --radius-lg: 20px;
      --transition: cubic-bezier(.25,.8,.25,1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .container {
      width: min(1080px, 92vw);
      margin: 0 auto;
      padding: 2.5rem 0 3.5rem;
    }

    .glass {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 26px;
      padding: clamp(1.6rem, 2vw, 2rem);
      box-shadow: 0 24px 60px rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(18px);
    }

    h1 {
      margin: 0 0 0.6rem;
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      letter-spacing: -0.01em;
    }

    p { margin: 0; color: var(--text-muted); line-height: 1.6; }

    form { display: grid; gap: 1.2rem; margin-top: 1.4rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    label { font-weight: 600; display: block; margin-bottom: 0.4rem; }
    select, input { width: 100%; border-radius: 14px; border: 1px solid var(--border); background: rgba(10, 15, 28, 0.9); color: var(--text-primary); padding: 0.85rem 0.95rem; font-size: 0.95rem; }
    select:focus, input:focus { outline: none; border-color: rgba(71, 245, 192, 0.7); box-shadow: 0 0 0 3px rgba(71, 245, 192, 0.2); }

    .full-row { grid-column: 1 / -1; }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.9rem 1.4rem;
      background: linear-gradient(135deg, rgba(71,245,192,0.95), rgba(124,247,255,0.9));
      color: #020617;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.25s var(--transition), box-shadow 0.25s var(--transition);
      width: 100%;
    }
    button:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 16px 30px rgba(71, 245, 192, 0.35); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

    .status { margin-top: 1rem; padding: 1rem; border-radius: 14px; background: rgba(15, 19, 32, 0.75); border: 1px solid rgba(148,163,184,0.18); color: var(--text-muted); min-height: 56px; }
    .status strong { color: var(--text-primary); }

    header { position: sticky; top: 0; backdrop-filter: blur(12px); background: rgba(4,7,17,0.7); border-bottom: 1px solid rgba(148,163,184,0.18); z-index: 10; }
    .header-inner { width: min(1080px, 92vw); margin: 0 auto; padding: 1.2rem 0; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 0.8rem; font-family: 'Space Grotesk', sans-serif; }
    .brand-mark { width: 2.6rem; height: 2.6rem; border-radius: 14px; display: grid; place-items: center; background: linear-gradient(135deg, rgba(71,245,192,0.2), rgba(124,247,255,0.26)); border: 1px solid rgba(148,163,184,0.25); color: #7cf7ff; font-weight: 700; box-shadow: inset 0 0 0 1px rgba(148,163,184,0.16); }
    .nav-toggle { display: none; width: 2.8rem; height: 2.8rem; border-radius: 16px; border: 1px solid rgba(148, 163, 184, 0.18); background: rgba(15, 19, 32, 0.68); color: var(--text-primary); align-items: center; justify-content: center; cursor: pointer; transition: transform 0.35s var(--transition), background 0.35s var(--transition); }
    .nav-toggle:hover { background: rgba(30, 41, 69, 0.75); }
    .nav-toggle span, .nav-toggle span::before, .nav-toggle span::after { display: block; width: 18px; height: 2px; background: currentColor; border-radius: 999px; position: relative; transition: transform 0.35s ease, opacity 0.3s ease; }
    .nav-toggle span::before, .nav-toggle span::after { content: ''; position: absolute; left: 0; }
    .nav-toggle span::before { top: -6px; }
    .nav-toggle span::after { top: 6px; }
    .nav-toggle.is-open span { background: transparent; }
    .nav-toggle.is-open span::before { transform: translateY(6px) rotate(45deg); }
    .nav-toggle.is-open span::after { transform: translateY(-6px) rotate(-45deg); }
    .stellar-nav { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-left: 1.2rem; border-radius: 16px; padding: 0.35rem; background: rgba(8, 12, 24, 0.55); border: 1px solid rgba(148, 163, 184, 0.16); box-shadow: inset 0 0 0 1px rgba(148,163,184,0.06); }
    .stellar-nav a { position: relative; display: inline-flex; align-items: center; gap: 0.45rem; padding: 0.65rem 1.05rem; border-radius: 14px; text-decoration: none; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); transition: color 0.3s var(--transition), transform 0.3s var(--transition), background 0.3s var(--transition); }
    .stellar-nav a::after { content: ''; position: absolute; inset: 0; border-radius: 14px; background: linear-gradient(135deg, rgba(71,245,192,0.16), rgba(124,247,255,0.14)); opacity: 0; transition: opacity 0.35s var(--transition); z-index: -1; }
    .stellar-nav a:hover { color: var(--text-primary); transform: translateY(-2px); }
    .stellar-nav a:hover::after { opacity: 1; }
    .stellar-nav a.active { color: var(--text-primary); }
    .stellar-nav a.active::after { opacity: 1; box-shadow: 0 8px 20px rgba(71, 245, 192, 0.18); }

    @media (max-width: 960px) {
      .header-inner { flex-direction: column; align-items: flex-start; gap: 0.8rem; }
      .nav-toggle { display: inline-flex; align-self: flex-end; }
      body.nav-open .stellar-nav { max-height: 600px; opacity: 1; pointer-events: auto; margin-top: 0.6rem; }
      .stellar-nav { width: 100%; margin-left: 0; flex-direction: column; max-height: 0; opacity: 0; pointer-events: none; overflow: hidden; transition: max-height 0.4s ease, opacity 0.4s ease; }
      .stellar-nav a { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-mark">EX</div>
        <div>
          <div style="font-weight:700; letter-spacing:0.02em;">ExBoot Laboratory</div>
          <div style="color:var(--text-muted); font-size:0.9rem;">Export PDF de questions</div>
        </div>
      </div>
      <button class="nav-toggle" id="navToggle" aria-expanded="false" aria-label="Afficher le menu">
        <span></span>
      </button>
      {% set active_page = 'pdf_export' %}
      {% include '_nav.html' %}
    </div>
  </header>

  <div class="container">
    <div class="glass">
      <h1>Assembler un PDF d'entraînement</h1>
      <p>Choisissez une certification, indiquez le nombre de questions à extraire et obtenez un PDF prêt à être utilisé basé sur le template ExamBoot.</p>

      <form id="exportForm">
        <div>
          <label>Provider</label>
          <select id="provider" name="provider" required></select>
        </div>
        <div>
          <label>Certification</label>
          <select id="certification" name="cert_id" required></select>
        </div>
        <div>
          <label>Nombre de questions</label>
          <input type="number" id="numQuestions" name="num_questions" min="1" value="10" required />
        </div>
        <div>
          <label>Nom complet (optionnel)</label>
          <input type="text" id="userName" name="user_name" placeholder="Nom utilisé dans le PDF" />
        </div>
        <div>
          <label>Email (optionnel)</label>
          <input type="email" id="userEmail" name="user_email" placeholder="Email affiché dans le PDF" />
        </div>
        <div class="full-row">
          <button type="submit" id="submitBtn">Générer le PDF</button>
        </div>
      </form>

      <div class="status" id="status">Sélectionnez une certification puis lancez la génération.</div>
    </div>
  </div>

  <script>
    const navToggle = document.getElementById('navToggle');
    const nav = document.getElementById('stellarNav');
    const navMediaQuery = window.matchMedia('(max-width: 960px)');

    if (navToggle && nav) {
      navToggle.addEventListener('click', () => {
        const isOpen = navToggle.classList.toggle('is-open');
        document.body.classList.toggle('nav-open', isOpen);
        navToggle.setAttribute('aria-expanded', isOpen);
      });
    }

    const closeNavOnDesktop = () => {
      if (!navMediaQuery.matches && navToggle) {
        document.body.classList.remove('nav-open');
        navToggle.classList.remove('is-open');
        navToggle.setAttribute('aria-expanded', 'false');
      }
    };

    navMediaQuery.addEventListener('change', closeNavOnDesktop);
    closeNavOnDesktop();

    const providerSelect = document.getElementById('provider');
    const certSelect = document.getElementById('certification');
    const form = document.getElementById('exportForm');
    const statusBox = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    function setStatus(message, isError = false) {
      statusBox.innerHTML = message;
      statusBox.style.color = isError ? '#fda4af' : 'var(--text-muted)';
    }

    async function loadProviders() {
      const res = await fetch('/pdf/api/providers');
      const data = await res.json();
      providerSelect.innerHTML = '<option value="">Choisir...</option>' + data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    async function loadCertifications(providerId) {
      certSelect.innerHTML = '<option value="">Choisir...</option>';
      if (!providerId) return;
      const res = await fetch(`/pdf/api/certifications/${providerId}`);
      const data = await res.json();
      certSelect.innerHTML = '<option value="">Choisir...</option>' + data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    providerSelect.addEventListener('change', (e) => {
      loadCertifications(e.target.value);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!certSelect.value) {
        setStatus('Veuillez choisir une certification.', true);
        return;
      }

      submitBtn.disabled = true;
      setStatus('Génération en cours...');

      const formData = new FormData(form);
      try {
        const response = await fetch('/pdf/export/questions', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.message || 'Une erreur est survenue');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const certName = certSelect.options[certSelect.selectedIndex].text || 'questions';
        a.download = `${certName.replace(/\s+/g, '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        setStatus('<strong>Succès :</strong> le PDF a été généré.');
      } catch (err) {
        setStatus(err.message, true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    loadProviders();
  </script>
</body>
</html>
