<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fix Questions - ExamBoot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .brand-bg { background-color:#28a745; }
    .brand-hover:hover { background-color:#218838; }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
  <nav class="brand-bg text-white">
    <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
      <a href="{{ url_for('home') }}" class="text-2xl font-semibold">ExBoot Laboratory</a>
      <ul class="flex flex-wrap space-x-4 mt-4 sm:mt-0">
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('populate_index') }}">Populate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('dom.index') }}">Import Modules</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('move.index') }}">Move Questions</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reloc.index') }}">Relocate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.index') }}">PDF Importer</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.generate_index') }}">PDF Generator</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('quest.index') }}">Manual Import</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('fix_index') }}">Fix Questions</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reports') }}">Reports</a></li>
      </ul>
    </div>
  </nav>

  <main class="container mx-auto px-4 mt-12">
    <div class="max-w-2xl mx-auto p-8 bg-white shadow-xl rounded">
      <h1 class="text-3xl font-bold text-center mb-8">Fix Questions</h1>
      <form id="fix-form" method="POST" action="{{ url_for('fix_process') }}" class="space-y-6">
        <div>
          <label for="provider_id" class="block text-lg font-medium text-gray-700">Provider:</label>
          <select name="provider_id" id="provider_id" class="mt-1 block w-full rounded border-gray-300 shadow-sm">
            {% for provider in providers %}
              <option value="{{ provider[0] }}" {% if selected_provider_id == provider[0] %}selected{% endif %}>{{ provider[1] }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="cert_id" class="block text-lg font-medium text-gray-700">Certification:</label>
          <select name="cert_id" id="cert_id" class="mt-1 block w-full rounded border-gray-300 shadow-sm" data-selected-cert="{{ selected_cert_id if selected_cert_id is not none else '' }}"></select>
        </div>
        <div>
          <label for="action" class="block text-lg font-medium text-gray-700">Type de traitement:</label>
          <select name="action" id="action" class="mt-1 block w-full rounded border-gray-300 shadow-sm">
            <option value="assign" {% if selected_action == 'assign' %}selected{% endif %}>Attribuer Réponse juste</option>
            <option value="drag" {% if selected_action == 'drag' %}selected{% endif %}>Compléter Drag-n-drop</option>
            <option value="matching" {% if selected_action == 'matching' %}selected{% endif %}>Compléter matching</option>
          </select>
        </div>
        <div>
          <button type="submit" id="startFix" class="w-full py-3 brand-bg text-white rounded brand-hover transition">Lancer</button>
        </div>
      </form>
      <div id="progress-section" class="mt-10 hidden">
        <div class="flex items-center justify-between text-sm font-semibold text-gray-700 mb-2">
          <span id="progress-label">Progression : 0%</span>
          <span id="progress-count">0 corrigée(s) sur 0</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
          <div id="progress-bar" class="brand-bg h-4 rounded-full transition-all duration-300" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
        </div>
        <p id="progress-remaining" class="mt-2 text-sm text-gray-600">Sélectionnez une certification pour afficher la progression.</p>
      </div>
      <div id="job-section" class="mt-10 hidden">
        <div class="flex items-center justify-between text-sm font-semibold text-gray-700 mb-2">
          <span id="job-status">En attente…</span>
          <span id="job-id-label" class="text-xs text-gray-500"></span>
        </div>
        <div class="border border-gray-300 rounded bg-gray-50 p-4 h-48 overflow-y-auto">
          <ul id="job-log-list" class="space-y-1 text-sm text-gray-700"></ul>
        </div>
      </div>
    </div>
  </main>

  <script>
    $(document).ready(function(){
      const $provider = $("#provider_id");
      const $cert = $("#cert_id");
      const $action = $("#action");
      const $progressSection = $("#progress-section");
      const $progressBar = $("#progress-bar");
      const $progressLabel = $("#progress-label");
      const $progressCount = $("#progress-count");
      const $progressRemaining = $("#progress-remaining");
      const $jobSection = $("#job-section");
      const $jobStatus = $("#job-status");
      const $jobIdLabel = $("#job-id-label");
      const $jobLogList = $("#job-log-list");

      let initialProgress = {{ initial_progress|tojson }};
      const statusUrlTemplate = "{{ url_for('fix_status', job_id='__JOB__') }}";
      const processUrl = "{{ url_for('fix_process') }}";
      let poller = null;
      let currentJobId = null;
      let lastLogIndex = 0;

      function parseValue(val){
        const num = Number(val);
        return Number.isFinite(num) ? num : 0;
      }

      function renderProgress(data){
        const total = parseValue(data && data.total);
        const corrected = parseValue(data && data.corrected);
        const remaining = parseValue(data && data.remaining);
        const safeCorrected = Math.max(Math.min(corrected, total), 0);
        const percent = total > 0 ? Math.round((safeCorrected / total) * 100) : 0;

        $progressBar.css("width", percent + "%");
        $progressBar.attr("aria-valuenow", percent);
        $progressLabel.text(`Progression : ${percent}%`);
        $progressCount.text(`${safeCorrected} corrigée(s) sur ${total}`);
        if (total === 0) {
          $progressRemaining.text("Aucune question à traiter pour cette sélection.");
        } else {
          $progressRemaining.text(`${Math.max(remaining, 0)} question(s) restante(s) à traiter.`);
        }
        $progressSection.removeClass("hidden");
      }

      function clearProgress(){
        $progressBar.css("width", "0%");
        $progressBar.attr("aria-valuenow", 0);
        $progressLabel.text("Progression : 0%");
        $progressCount.text("0 corrigée(s) sur 0");
        $progressRemaining.text("Sélectionnez une certification pour afficher la progression.");
        $progressSection.addClass("hidden");
      }

      function resetJobSection(){
        if(poller){
          clearInterval(poller);
          poller = null;
        }
        currentJobId = null;
        lastLogIndex = 0;
        $jobStatus.text("En attente…");
        $jobIdLabel.text("");
        $jobLogList.empty();
        $jobSection.addClass("hidden");
      }

      function appendJobLog(message, cssClass){
        const li = $("<li>").text(message);
        if(cssClass){
          li.addClass(cssClass);
        }
        $jobLogList.append(li);
      }

      function fetchJobStatus(jobId){
        if(!jobId){
          return;
        }
        $.get(statusUrlTemplate.replace('__JOB__', jobId), function(data){
          if(data && Array.isArray(data.log)){
            for(; lastLogIndex < data.log.length; lastLogIndex++){
              appendJobLog(data.log[lastLogIndex]);
            }
          }
          if(data && data.counters){
            renderProgress(data.counters);
          }
          if(data && data.status){
            const status = data.status;
            if(status === "queued"){
              $jobStatus.text("En attente d'un worker…");
            } else if(status === "running"){
              $jobStatus.text("Traitement en cours…");
            } else if(status === "paused"){
              $jobStatus.text("Traitement en pause.");
            } else if(status === "completed"){
              $jobStatus.text("Traitement terminé.");
            } else if(status === "failed"){
              $jobStatus.text("Erreur pendant le traitement.");
            } else {
              $jobStatus.text(status);
            }

            if(status === "completed" || status === "failed"){
              if(poller){
                clearInterval(poller);
                poller = null;
              }
              currentJobId = null;
              updateProgress();
              if(status === "failed" && data.error){
                appendJobLog("Erreur: " + data.error, "text-red-600");
              }
            }
          }
        }, "json").fail(function(xhr){
          if(poller){
            clearInterval(poller);
            poller = null;
          }
          currentJobId = null;
          if(xhr.status === 404){
            appendJobLog("Statut indisponible : job introuvable.", "text-red-600");
            $jobStatus.text("Statut inconnu.");
          } else {
            appendJobLog("Impossible de récupérer le statut du job.", "text-red-600");
            $jobStatus.text("Erreur de suivi.");
          }
        });
      }

      function startPolling(jobId){
        if(poller){
          clearInterval(poller);
        }
        poller = setInterval(function(){ fetchJobStatus(jobId); }, 1000);
        fetchJobStatus(jobId);
      }

      function updateProgress(){
        const certId = $cert.val();
        const action = $action.val();
        if (!certId){
          clearProgress();
          return;
        }
        $.post("{{ url_for('fix_get_progress') }}", { cert_id: certId, action: action }, function(data){
          renderProgress(data || {});
        }, "json").fail(function(){
          clearProgress();
        });
      }

      function loadCertifications(prefillCertId){
        const providerId = $provider.val();
        if (!providerId){
          $cert.empty();
          clearProgress();
          resetJobSection();
          return;
        }

        $.post("{{ url_for('fix_get_certifications') }}", { provider_id: providerId }, function(data){
          $cert.empty();
          if (Array.isArray(data) && data.length){
            $.each(data, function(_, item){
              $cert.append($("<option>", { value: item.id, text: item.name }));
            });
            if (prefillCertId !== undefined && prefillCertId !== null && prefillCertId !== ""){
              $cert.val(String(prefillCertId));
            }
            if (!$cert.val()){
              $cert.prop("selectedIndex", 0);
            }
            const selectedCert = $cert.val();
            if (initialProgress && prefillCertId && String(prefillCertId) === String(selectedCert)){
              renderProgress(initialProgress);
              initialProgress = null;
            } else {
              updateProgress();
            }
          } else {
            clearProgress();
            resetJobSection();
          }
        }, "json").fail(function(){
          clearProgress();
          resetJobSection();
        });
      }

      $("#fix-form").on("submit", function(evt){
        evt.preventDefault();
        const providerId = $provider.val();
        const certId = $cert.val();
        const action = $action.val();

        if(!providerId || !certId){
          resetJobSection();
          $jobSection.removeClass("hidden");
          $jobStatus.text("Sélection incomplète.");
          appendJobLog("Veuillez sélectionner un provider et une certification.", "text-red-600");
          return;
        }

        resetJobSection();
        $jobSection.removeClass("hidden");
        $jobStatus.text("Démarrage du traitement…");
        $.post(processUrl, { provider_id: providerId, cert_id: certId, action: action }, function(resp){
          if(resp && resp.job_id){
            currentJobId = resp.job_id;
            lastLogIndex = 0;
            $jobIdLabel.text("Job ID: " + resp.job_id);
            $jobStatus.text("Traitement en cours…");
            startPolling(currentJobId);
          } else {
            $jobStatus.text("Impossible de démarrer le traitement.");
            appendJobLog("Réponse inattendue du serveur.", "text-red-600");
          }
        }, "json").fail(function(xhr){
          $jobStatus.text("Impossible de démarrer le traitement.");
          let message = "Erreur serveur.";
          if(xhr.responseJSON && xhr.responseJSON.error){
            message = xhr.responseJSON.error;
          }
          appendJobLog(message, "text-red-600");
        });
      });

      $provider.on("change", function(){
        initialProgress = null;
        resetJobSection();
        loadCertifications("");
      });

      $cert.on("change", function(){
        initialProgress = null;
        resetJobSection();
        updateProgress();
      });

      $action.on("change", function(){
        initialProgress = null;
        resetJobSection();
        updateProgress();
      });

      const initialCert = $cert.data("selected-cert");
      loadCertifications(initialCert);
    });
  </script>
</body>
</html>
