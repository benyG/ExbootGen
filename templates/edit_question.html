<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Question · ExBoot Laboratory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #050814;
      --panel: rgba(13, 17, 28, 0.8);
      --panel-soft: rgba(14, 18, 30, 0.75);
      --border: rgba(255, 255, 255, 0.08);
      --accent: #5cf1c7;
      --accent-strong: #7cf7ff;
      --text: #e5e7eb;
      --muted: rgba(229, 231, 235, 0.7);
      --shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
      --radius: 18px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(92,241,199,0.18), transparent 40%),
                  radial-gradient(circle at 75% 10%, rgba(124,247,255,0.18), transparent 45%),
                  radial-gradient(circle at 50% 80%, rgba(244,114,182,0.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding-bottom: 64px;
    }

    .stellar-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(5, 8, 20, 0.8);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
    }

    .stellar-container { width: min(1200px, 94vw); margin: 0 auto; padding: 1rem 0 1.25rem; }
    .stellar-top { display: flex; align-items: center; justify-content: space-between; }
    .stellar-brand { display: flex; align-items: center; gap: 0.9rem; font-family: 'Space Grotesk', sans-serif; }
    .brand-mark { width: 2.75rem; height: 2.75rem; display: grid; place-items: center; border-radius: 16px; background: linear-gradient(135deg, rgba(92,241,199,0.16), rgba(124,247,255,0.18)); border: 1px solid var(--border); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); color: var(--accent-strong); letter-spacing: 0.08em; font-weight: 700; }
    .brand-text strong { display: block; letter-spacing: 0.02em; }
    .brand-text span { color: var(--muted); font-size: 0.9rem; }

    .stellar-nav { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1rem; }
    .stellar-nav a { color: var(--muted); text-decoration: none; padding: 0.55rem 0.9rem; border-radius: 12px; border: 1px solid transparent; transition: 0.2s ease; }
    .stellar-nav a:hover { color: var(--text); border-color: var(--border); background: rgba(255,255,255,0.04); }
    .stellar-nav a.active { color: #0b172a; background: var(--accent); border-color: transparent; }

    .nav-toggle { display: none; width: 48px; height: 48px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .nav-toggle span, .nav-toggle::before { display: block; width: 18px; height: 2px; background: currentColor; transition: 0.25s ease; }
    .nav-toggle::before { content: ''; width: 14px; }

    main { width: min(1200px, 94vw); margin: 28px auto; display: flex; flex-direction: column; gap: 1rem; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.2rem 1.4rem; box-shadow: var(--shadow); }
    .panel h2 { margin: 0 0 0.25rem; }
    .panel p { margin: 0; color: var(--muted); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    label { display: block; margin-bottom: 0.45rem; color: var(--muted); font-size: 0.95rem; }
    input[type="text"], select, textarea { width: 100%; background: var(--panel-soft); border: 1px solid var(--border); color: var(--text); border-radius: 12px; padding: 0.75rem 0.9rem; font-size: 1rem; }
    textarea { min-height: 72px; resize: vertical; }

    button.primary { background: linear-gradient(135deg, #5cf1c7, #7cf7ff); border: none; color: #071026; font-weight: 700; padding: 0.9rem 1.2rem; border-radius: 12px; cursor: pointer; box-shadow: 0 15px 35px rgba(92,241,199,0.35); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 0.75rem 1rem; border-radius: 10px; cursor: pointer; }

    .results { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 0.9rem; }
    .result-card { background: var(--panel-soft); border: 1px solid var(--border); border-radius: 14px; padding: 0.9rem 1rem; cursor: pointer; transition: 0.2s ease; }
    .result-card:hover { border-color: rgba(124,247,255,0.6); transform: translateY(-2px); }
    .result-card small { display: block; color: var(--muted); margin-top: 0.35rem; }
    .result-card .src { color: #c084fc; font-size: 0.9rem; }

    .editor { background: var(--panel-soft); border: 1px solid var(--border); border-radius: var(--radius); min-height: 200px; padding: 1rem; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 0.45rem; margin-bottom: 0.75rem; }
    .toolbar button { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); padding: 0.55rem 0.75rem; border-radius: 10px; cursor: pointer; }
    .toolbar button:hover { border-color: var(--accent); color: var(--accent); }

    .answers { display: flex; flex-direction: column; gap: 0.75rem; }
    .answer-item { background: var(--panel-soft); border: 1px solid var(--border); border-radius: 12px; padding: 0.9rem; display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center; }
    .answer-item textarea { width: 100%; min-height: 64px; }
    .answer-item .meta { color: var(--muted); font-size: 0.9rem; }

    .status { font-size: 0.95rem; color: var(--muted); }

    @media (max-width: 800px) {
      .stellar-nav { display: none; }
      .nav-toggle { display: inline-flex; }
      body.nav-open .stellar-nav { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); margin-top: 1rem; }
      .answer-item { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="stellar-header">
    <div class="stellar-container">
      <div class="stellar-top">
        <div class="stellar-brand">
          <span class="brand-mark">EX</span>
          <div class="brand-text">
            <strong>ExBoot Laboratory</strong>
            <span>Éditeur de questions</span>
          </div>
        </div>
        <button class="nav-toggle" id="navToggle" aria-label="Ouvrir la navigation"><span></span></button>
      </div>
      {% set active_page = 'edit_question' %}
      {% include '_nav.html' %}
    </div>
  </header>

  <main>
    <section class="panel">
      <h1>Rechercher et éditer une question</h1>
      <p>Filtrez par texte, provider et certification. Cliquez sur une carte pour afficher et modifier le contenu, l'origine et les réponses de la question.</p>
    </section>

    <section class="panel">
      <div class="grid">
        <div>
          <label for="searchText">Texte à rechercher</label>
          <input type="text" id="searchText" placeholder="Mots-clés de la question">
        </div>
        <div>
          <label for="providerSelect">Provider</label>
          <select id="providerSelect"></select>
        </div>
        <div>
          <label for="certificationSelect">Certification</label>
          <select id="certificationSelect"></select>
        </div>
      </div>
      <div style="margin-top: 0.8rem; display: flex; gap: 0.6rem; align-items: center;">
        <button class="primary" id="searchBtn">Lancer la recherche</button>
        <span class="status" id="searchStatus">Saisissez au moins un mot-clé.</span>
      </div>
    </section>

    <section class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h2 style="margin: 0;">Résultats</h2>
        <span class="status" id="resultsCount">Aucun résultat pour le moment.</span>
      </div>
      <div class="results" id="results"></div>
    </section>

    <section class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h2 style="margin: 0;">Éditeur</h2>
          <p class="status" id="editorStatus">Sélectionnez une question pour l'éditer.</p>
        </div>
        <div class="status" id="contextInfo"></div>
      </div>

      <div style="margin: 1rem 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 0.75rem;">
        <div>
          <label for="srcFile">Source (src_file)</label>
          <input type="text" id="srcFile" placeholder="Fichier d'origine">
        </div>
        <div>
          <label for="descrInput">Description / diagramme</label>
          <input type="text" id="descrInput" placeholder="Description facultative de la question">
        </div>
      </div>

      <div class="toolbar">
        <button type="button" data-cmd="bold"><strong>Gras</strong></button>
        <button type="button" data-cmd="italic"><em>Italique</em></button>
        <button type="button" data-cmd="underline"><u>Souligné</u></button>
        <button type="button" data-cmd="insertUnorderedList">Liste</button>
        <button type="button" data-cmd="insertOrderedList">Liste numérotée</button>
        <button type="button" id="addTable">Tableau</button>
        <button type="button" id="addImage">Image</button>
        <button type="button" data-cmd="createLink">Lien</button>
      </div>
      <div class="editor" id="questionEditor" contenteditable="true" aria-label="Éditeur de question"></div>

      <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Réponses</h3>
        <button type="button" class="secondary" id="addAnswer">Ajouter une réponse</button>
      </div>
      <div class="answers" id="answers"></div>

      <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
        <button class="primary" id="saveBtn" disabled>Enregistrer les modifications</button>
        <span class="status" id="saveStatus"></span>
      </div>
    </section>
  </main>

  <script>
    const navToggle = document.getElementById('navToggle');
    const nav = document.getElementById('stellarNav');
    navToggle?.addEventListener('click', () => {
      const isOpen = document.body.classList.toggle('nav-open');
      navToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });

    const providerSelect = document.getElementById('providerSelect');
    const certificationSelect = document.getElementById('certificationSelect');
    const resultsContainer = document.getElementById('results');
    const resultsCount = document.getElementById('resultsCount');
    const searchStatus = document.getElementById('searchStatus');
    const searchText = document.getElementById('searchText');
    const questionEditor = document.getElementById('questionEditor');
    const srcFileInput = document.getElementById('srcFile');
    const descrInput = document.getElementById('descrInput');
    const editorStatus = document.getElementById('editorStatus');
    const contextInfo = document.getElementById('contextInfo');
    const answersContainer = document.getElementById('answers');
    const saveBtn = document.getElementById('saveBtn');
    const saveStatus = document.getElementById('saveStatus');

    let currentQuestionId = null;

    const currentPath = window.location.pathname.replace(/\/$/, '') || '/';
    nav?.querySelectorAll('a[data-route]').forEach(link => {
      const target = (link.dataset.route || '').replace(/\/$/, '') || '/';
      if (target === '/' ? currentPath === '/' : currentPath.startsWith(target)) {
        nav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
        link.classList.add('active');
      }
    });

    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    };

    function setSelectOptions(selectEl, placeholder, items) {
      selectEl.innerHTML = '';
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = placeholder;
      selectEl.appendChild(defaultOpt);

      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.textContent = item.name ?? '';
        selectEl.appendChild(opt);
      });
    }

    async function loadProviders() {
      const res = await fetch('/edit-question/api/providers');
      const providers = await res.json();
      setSelectOptions(providerSelect, '— Tous —', providers);
    }

    async function loadCertifications() {
      const provId = providerSelect.value;
      setSelectOptions(certificationSelect, '— Toutes —', []);
      if (!provId) return;
      const res = await fetch(`/edit-question/api/certifications/${provId}`);
      const certs = await res.json();
      setSelectOptions(certificationSelect, '— Toutes —', certs);
    }

    async function searchQuestions() {
      const q = searchText.value.trim();
      if (!q) {
        searchStatus.textContent = 'Veuillez saisir un mot-clé.';
        return;
      }
      searchStatus.textContent = 'Recherche en cours…';
      resultsContainer.innerHTML = '';
      const params = new URLSearchParams({ q });
      if (providerSelect.value) params.append('provider_id', providerSelect.value);
      if (certificationSelect.value) params.append('certification_id', certificationSelect.value);
      const res = await fetch(`/edit-question/api/search?${params.toString()}`);
      const data = await res.json();
      const results = data.results || [];
      resultsCount.textContent = `${results.length} résultat(s)`;
      searchStatus.textContent = results.length ? 'Cliquez sur une carte pour charger la question.' : 'Aucun résultat pour cette recherche.';

      resultsContainer.innerHTML = results.map(r => `
        <article class="result-card" data-id="${r.id}">
          <strong>#${r.id} · ${escapeHtml(r.module_name || 'Module ?')}</strong>
          <div style="margin-top: 0.3rem;">${escapeHtml(r.text_preview || '—')}</div>
          <small>${escapeHtml(r.provider || 'Provider ?')} · ${escapeHtml(r.certification || 'Certification ?')}</small>
          <small class="src">${r.src_file ? `src_file : ${escapeHtml(r.src_file)}` : 'src_file non renseigné'}</small>
        </article>
      `).join('');
    }

    async function loadQuestion(questionId) {
      const res = await fetch(`/edit-question/api/questions/${questionId}`);
      if (!res.ok) {
        editorStatus.textContent = 'Impossible de charger la question.';
        return;
      }
      const q = await res.json();
      currentQuestionId = q.id;
      questionEditor.innerHTML = q.text || '';
      srcFileInput.value = q.src_file || '';
      descrInput.value = q.descr || '';
      contextInfo.textContent = `${q.provider_name || ''} → ${q.certification_name || ''} → ${q.module_name || ''}`;
      editorStatus.textContent = `Édition de la question #${q.id}`;
      saveBtn.disabled = false;
      renderAnswers(q.answers || []);
    }

    function renderAnswers(items) {
      answersContainer.innerHTML = '';
      if (!items.length) {
        addAnswerField();
        return;
      }
      items.forEach(item => addAnswerField(item.value || '', item.isok, item.meta));
    }

    function addAnswerField(value = '', isok = false, meta = {}) {
      const wrapper = document.createElement('div');
      wrapper.className = 'answer-item';
      wrapper.dataset.meta = JSON.stringify(meta || {});
      wrapper.innerHTML = `
        <textarea placeholder="Texte de la réponse"></textarea>
        <div style="display:flex; flex-direction: column; align-items: flex-end; gap: 0.45rem;">
          <label style="display:flex; align-items:center; gap:0.35rem; color: var(--muted); font-size:0.95rem;">
            <input type="checkbox" ${isok ? 'checked' : ''}> Correcte
          </label>
          <button type="button" class="secondary remove-answer">Supprimer</button>
        </div>
      `;
      const textarea = wrapper.querySelector('textarea');
      textarea.value = value || '';
      wrapper.querySelector('.remove-answer').addEventListener('click', () => wrapper.remove());
      answersContainer.appendChild(wrapper);
    }

    function execCommand(cmd) {
      if (cmd === 'createLink') {
        const url = prompt('URL du lien');
        if (url) document.execCommand(cmd, false, url);
        return;
      }
      document.execCommand(cmd, false, null);
      questionEditor.focus();
    }

    document.querySelectorAll('.toolbar button[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => execCommand(btn.dataset.cmd));
    });

    document.getElementById('addTable').addEventListener('click', () => {
      const rows = parseInt(prompt('Nombre de lignes ?', '2'), 10) || 2;
      const cols = parseInt(prompt('Nombre de colonnes ?', '2'), 10) || 2;
      let html = '<table style="width:100%; border-collapse: collapse;">';
      for (let r = 0; r < rows; r++) {
        html += '<tr>';
        for (let c = 0; c < cols; c++) {
          html += '<td style="border:1px solid #94a3b8; padding:6px;">Cellule</td>';
        }
        html += '</tr>';
      }
      html += '</table>';
      document.execCommand('insertHTML', false, html);
    });

    document.getElementById('addImage').addEventListener('click', () => {
      const url = prompt('URL de l\'image');
      if (url) {
        document.execCommand('insertImage', false, url);
      }
    });

    document.getElementById('addAnswer').addEventListener('click', () => addAnswerField());

    resultsContainer.addEventListener('click', (e) => {
      const card = e.target.closest('.result-card');
      if (card?.dataset.id) {
        loadQuestion(card.dataset.id);
      }
    });

    document.getElementById('searchBtn').addEventListener('click', searchQuestions);
    searchText.addEventListener('keyup', (e) => { if (e.key === 'Enter') searchQuestions(); });
    providerSelect.addEventListener('change', () => { loadCertifications(); searchQuestions(); });
    certificationSelect.addEventListener('change', searchQuestions);

    saveBtn.addEventListener('click', async () => {
      if (!currentQuestionId) return;
      saveStatus.textContent = 'Enregistrement en cours…';
      const answers = Array.from(document.querySelectorAll('.answer-item')).map(item => {
        const meta = item.dataset.meta ? JSON.parse(item.dataset.meta) : {};
        return {
          value: item.querySelector('textarea').value.trim(),
          isok: item.querySelector('input[type="checkbox"]').checked,
          meta,
        };
      });
      const payload = {
        text: questionEditor.innerHTML.trim(),
        src_file: srcFileInput.value.trim(),
        descr: descrInput.value.trim(),
        answers,
      };
      const res = await fetch(`/edit-question/api/questions/${currentQuestionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        saveStatus.textContent = 'Question mise à jour avec succès.';
      } else {
        const err = await res.json().catch(() => ({}));
        saveStatus.textContent = err.error || 'Erreur pendant la sauvegarde.';
      }
    });

    loadProviders();
  </script>
</body>
</html>
