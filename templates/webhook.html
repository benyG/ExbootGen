<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webhook · ExBoot Laboratory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #050814;
      --card: rgba(10, 14, 24, 0.76);
      --border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --muted: rgba(226, 232, 240, 0.72);
      --accent: #5cf1c7;
      --accent-strong: #7cf7ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(92,241,199,0.18), transparent 40%),
                  radial-gradient(circle at 75% 10%, rgba(124,247,255,0.18), transparent 45%),
                  radial-gradient(circle at 50% 80%, rgba(244,114,182,0.14), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .stellar-header { position: sticky; top: 0; z-index: 20; background: rgba(5, 8, 20, 0.8); backdrop-filter: blur(14px); border-bottom: 1px solid var(--border); }
    .stellar-container { width: min(1200px, 94vw); margin: 0 auto; padding: 1rem 0 1.25rem; }
    .stellar-top { display: flex; justify-content: space-between; align-items: center; }
    .stellar-brand { display: flex; align-items: center; gap: 0.9rem; font-family: 'Space Grotesk', sans-serif; font-weight: 700; }
    .brand-mark { width: 2.75rem; height: 2.75rem; display: grid; place-items: center; border-radius: 16px; background: linear-gradient(135deg, rgba(92,241,199,0.16), rgba(124,247,255,0.18)); border: 1px solid var(--border); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); color: var(--accent-strong); letter-spacing: 0.08em; font-weight: 700; }
    .brand-text strong { display: block; letter-spacing: 0.02em; }
    .brand-text span { color: var(--muted); font-size: 0.9rem; }
    .stellar-nav { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1rem; }
    .stellar-nav a { color: var(--muted); text-decoration: none; padding: 0.55rem 0.9rem; border-radius: 12px; border: 1px solid transparent; transition: 0.2s ease; }
    .stellar-nav a:hover { color: var(--text); border-color: var(--border); background: rgba(255,255,255,0.04); }
    .stellar-nav a.active { color: #0b172a; background: var(--accent); border-color: transparent; }
    .main { width: min(1200px, 92vw); margin: 2rem auto 3rem; display: grid; gap: 1.5rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 1.4rem; }
    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .badge { padding: 0.3rem 0.75rem; border-radius: 999px; border: 1px solid rgba(94, 234, 212, 0.45); color: var(--accent-strong); background: rgba(16, 185, 129, 0.12); font-size: 0.78rem; font-weight: 600; letter-spacing: 0.02em; }
    .muted { color: var(--muted); }
    .url-box { margin-top: 0.8rem; padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid rgba(94, 234, 212, 0.25); background: rgba(56, 189, 248, 0.12); font-family: 'Space Grotesk', sans-serif; font-size: 0.95rem; }
    .events { display: grid; gap: 0.9rem; }
    .event-card { border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(12, 16, 28, 0.85); padding: 1rem; }
    .event-meta { display: flex; flex-wrap: wrap; gap: 0.6rem; align-items: center; margin-bottom: 0.6rem; font-size: 0.82rem; color: var(--muted); }
    .event-meta strong { color: var(--text); font-weight: 600; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; background: rgba(7, 10, 18, 0.9); border-radius: 12px; padding: 0.85rem; border: 1px solid rgba(148, 163, 184, 0.16); font-size: 0.85rem; }
    .empty { text-align: center; padding: 2rem; border: 1px dashed rgba(148, 163, 184, 0.3); border-radius: 16px; color: var(--muted); }
  </style>
</head>
<body>
  <header class="stellar-header">
    <div class="stellar-container">
      <div class="stellar-top">
        <div class="stellar-brand">
          <span class="brand-mark">EX</span>
          <div class="brand-text">
            <strong>ExBoot Laboratory</strong>
            <span>Webhook monitoring</span>
          </div>
        </div>
      </div>
      {% set active_page = 'webhook' %}
      {% include '_nav.html' %}
    </div>
  </header>

  <main class="main">
    <section class="card">
      <div class="card-header">
        <div>
          <h2>Webhook Viewer</h2>
          <p class="muted">Surveillez les évènements entrants en temps réel.</p>
        </div>
        <span class="badge" id="webhookStatus">En écoute</span>
      </div>
      <div class="url-box">URL à déclarer : http://&lt;IP&gt;:&lt;PORT&gt;/webhook</div>
    </section>

    <section class="card">
      <div class="card-header">
        <h3>Évènements reçus</h3>
        <span class="muted" id="eventCount">0 évènement</span>
      </div>
      <div id="events" class="events"></div>
      <div id="emptyState" class="empty">Aucun évènement reçu pour le moment.</div>
    </section>
  </main>

  <script>
    const initialEvents = {{ events | tojson }};
    const eventsContainer = document.getElementById('events');
    const emptyState = document.getElementById('emptyState');
    const eventCount = document.getElementById('eventCount');
    let lastId = 0;

    const formatPayload = (event) => ({
      received_at: event.received_at,
      source_ip: event.source_ip,
      data: event.data,
    });

    const updateCount = () => {
      const count = eventsContainer.children.length;
      eventCount.textContent = `${count} évènement${count > 1 ? 's' : ''}`;
      emptyState.style.display = count === 0 ? 'block' : 'none';
    };

    const renderEvent = (event, { prepend = true } = {}) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'event-card';
      wrapper.dataset.eventId = event.id;

      const meta = document.createElement('div');
      meta.className = 'event-meta';
      meta.innerHTML = `<strong>#${event.id}</strong> <span>${event.received_at}</span> <span>IP: ${event.source_ip || 'N/A'}</span>`;

      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(formatPayload(event), null, 2);

      wrapper.appendChild(meta);
      wrapper.appendChild(pre);

      if (prepend) {
        eventsContainer.prepend(wrapper);
      } else {
        eventsContainer.appendChild(wrapper);
      }
    };

    initialEvents.forEach((event) => {
      renderEvent(event, { prepend: false });
      lastId = Math.max(lastId, event.id);
    });
    updateCount();

    const fetchEvents = async () => {
      try {
        const response = await fetch(`/stats/webhook/events?after=${lastId}`);
        if (!response.ok) {
          throw new Error('Erreur de réponse');
        }
        const payload = await response.json();
        payload.events.forEach((event) => {
          renderEvent(event, { prepend: true });
          lastId = Math.max(lastId, event.id);
        });
        const cards = Array.from(eventsContainer.children);
        if (cards.length > 50) {
          cards.slice(50).forEach((card) => card.remove());
        }
        updateCount();
      } catch (error) {
        console.error(error);
      }
    };

    setInterval(fetchEvents, 3000);
  </script>
</body>
</html>
