<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Import PDF Questions</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .brand-bg { background-color:#28a745; }
    .brand-hover:hover { background-color:#218838; }
  </style>
</head>
<body class="bg-gray-100">
  <nav class="brand-bg text-white">
    <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
      <a href="{{ url_for('home') }}" class="text-2xl font-semibold">ExBoot Laboratory</a>
      <ul class="flex flex-wrap space-x-4 mt-4 sm:mt-0">
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('populate_index') }}">Populate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('dom.index') }}">Import Modules</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('move.index') }}">Move Questions</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reloc.index') }}">Relocate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.index') }}">PDF Importer</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('quest.index') }}">Manual Import</a></li>
      </ul>
    </div>
  </nav>
  <main class="container mx-auto px-4 mt-8">
    <div class="max-w-3xl mx-auto bg-white p-8 shadow rounded">
      <h2 class="text-2xl font-bold text-center mb-4">üìÑ Import PDF Questions</h2>
      <form id="uploadForm" enctype="multipart/form-data" class="space-y-4 mb-4">
        <div>
          <label class="font-bold block mb-1">Provider:</label>
          <select name="provider_id" id="providerSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">Certification:</label>
          <select name="cert_id" id="certSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">Module:</label>
          <select name="module_id" id="moduleSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">PDF File:</label>
          <input type="file" name="file" class="w-full border rounded p-2" accept=".pdf,application/pdf" required>
        </div>
        <button type="submit" id="analyzeBtn" class="brand-bg text-white w-full py-2 rounded brand-hover">Analyser PDF</button>
      </form>
      <div id="jsonContainer" class="hidden">
        <h4 class="text-lg font-bold mb-2">üìã JSON extrait</h4>
        <textarea id="jsonPreview" class="w-full h-72 border rounded p-2 font-mono bg-gray-800 text-gray-100" readonly></textarea>
        <button id="confirmImport" class="brand-bg text-white w-full py-2 rounded mt-3 brand-hover">‚úÖ Confirmer Import</button>
      </div>
    </div>
  </main>
<script>
// helper
function option(text, value) {
    const o = document.createElement("option");
    o.textContent = text; o.value = value;
    return o;
}

const base = '{{ url_for('pdf.index') }}';

// 1) Providers -> auto-s√©lection + cascade
fetch(base + "api/providers").then(r => r.json()).then(data => {
    const providerSelect = document.getElementById("providerSelect");
    providerSelect.innerHTML = "";
    if (!data || data.length === 0) {
        providerSelect.appendChild(option("‚Äî Aucun provider ‚Äî", ""));
        return;
    }
    data.forEach(p => providerSelect.appendChild(option(p.name, p.id)));
    providerSelect.value = data[0].id;
    providerSelect.dispatchEvent(new Event("change"));
});

// 2) Provider change -> Certifications (puis cascade vers Modules)
document.getElementById("providerSelect").addEventListener("change", function () {
    const prov_id = this.value;
    const certSelect = document.getElementById("certSelect");
    const modSelect  = document.getElementById("moduleSelect");

    certSelect.innerHTML = "";
    modSelect.innerHTML  = "";

    if (!prov_id) {
        certSelect.appendChild(option("‚Äî Aucune certification ‚Äî", ""));
        modSelect.appendChild(option("‚Äî Aucun module ‚Äî", ""));
        return;
    }

    fetch(`${base}api/certifications/${prov_id}`).then(r => r.json()).then(data => {
        certSelect.innerHTML = "";
        if (!data || data.length === 0) {
            certSelect.appendChild(option("‚Äî Aucune certification ‚Äî", ""));
            modSelect.appendChild(option("‚Äî Aucun module ‚Äî", ""));
            return;
        }
        data.forEach(c => certSelect.appendChild(option(c.name, c.id)));
        certSelect.value = data[0].id;
        certSelect.dispatchEvent(new Event("change"));
    }).catch(() => {
        certSelect.innerHTML = ""; modSelect.innerHTML = "";
        certSelect.appendChild(option("‚Äî Erreur chargement ‚Äî", ""));
    });
});

// 3) Certification change -> Modules (auto-s√©lection du 1er)
document.getElementById("certSelect").addEventListener("change", function () {
    const cert_id = this.value;
    const modSelect = document.getElementById("moduleSelect");

    modSelect.innerHTML = "";
    if (!cert_id) {
        modSelect.appendChild(option("‚Äî Aucun module ‚Äî", ""));
        return;
    }

    fetch(`${base}api/modules/${cert_id}`).then(r => r.json()).then(data => {
        modSelect.innerHTML = "";
        if (!data || data.length === 0) {
            modSelect.appendChild(option("‚Äî Aucun module ‚Äî", ""));
            return;
        }
        data.forEach(m => modSelect.appendChild(option(m.name, m.id)));
        modSelect.value = data[0].id;
    }).catch(() => {
        modSelect.appendChild(option("‚Äî Erreur chargement ‚Äî", ""));
    });
});

// 4) Soumission pour analyse PDF
let currentSession = null;
document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("analyzeBtn");
    btn.disabled = true;

    try {
        const formData = new FormData(this);
        const res = await fetch(base + "upload-pdf", { method: "POST", body: formData });
        const data = await res.json();
        if (data.status === "ok") {
            currentSession = data.session_id;
            document.getElementById("jsonPreview").value = JSON.stringify(data.json_data, null, 4);
            document.getElementById("jsonContainer").classList.remove("hidden");
        } else {
            alert("Erreur : " + (data.message || "analyse impossible"));
        }
    } catch (err) {
        alert("Erreur r√©seau : " + err);
    } finally {
        btn.disabled = false;
    }
});

// 5) Confirmation import (affiche les bonnes cl√©s de la r√©ponse)
document.getElementById("confirmImport").addEventListener("click", async function() {
    if (!currentSession) {
        alert("Aucune session d‚Äôanalyse en m√©moire. Analyse un PDF d‚Äôabord.");
        return;
    }
    const formData = new FormData();
    formData.append("session_id", currentSession);

    try {
        const res = await fetch(base + "import-questions", { method: "POST", body: formData });
        const data = await res.json();
        if (data.status === "ok") {
            alert(`‚úÖ Import termin√© : ${data.imported_questions} questions, ${data.imported_answers} r√©ponses`);
        } else {
            alert("‚ùå Erreur import : " + (data.message || "√©chec"));
        }
    } catch (err) {
        alert("Erreur r√©seau : " + err);
    }
});
</script>
</body>
</html>
