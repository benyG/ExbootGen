<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Import PDF Questions</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .brand-bg { background-color:#28a745; }
    .brand-hover:hover { background-color:#218838; }
    #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%;
                      background:rgba(0,0,0,0.4); display:none; align-items:center;
                      justify-content:center; z-index:50; }
    #loadingOverlay.show { display:flex; }
    .loader { border:8px solid #f3f3f3; border-top:8px solid #28a745; border-radius:50%;
              width:60px; height:60px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100">
  <nav class="brand-bg text-white">
    <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
      <a href="{{ url_for('home') }}" class="text-2xl font-semibold">ExBoot Laboratory</a>
      <ul class="flex flex-wrap space-x-4 mt-4 sm:mt-0">
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('populate_index') }}">Populate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('dom.index') }}">Import Modules</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('move.index') }}">Move Questions</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reloc.index') }}">Relocate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.index') }}">PDF Importer</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.generate_index') }}">PDF Generator</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('quest.index') }}">Manual Import</a></li>
      </ul>
    </div>
  </nav>
  <main class="container mx-auto px-4 mt-8">
    <div class="max-w-3xl mx-auto bg-white p-8 shadow rounded">
      <h2 class="text-2xl font-bold text-center mb-4">📄 Import PDF Questions</h2>
      <form id="uploadForm" class="space-y-4 mb-4">
        <div>
          <label class="font-bold block mb-1">Provider:</label>
          <select name="provider_id" id="providerSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">Certification:</label>
          <select name="cert_id" id="certSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">Module:</label>
          <input type="text" id="moduleSearch" placeholder="Rechercher..." class="w-full border rounded p-2 mb-2">
          <select name="module_id" id="moduleSelect" class="w-full border rounded p-2" required></select>
        </div>
        <div>
          <label class="font-bold block mb-1">PDF Folder:</label>
          <input type="text" id="dirInput" class="w-full border rounded p-2" placeholder="/chemin/vers/dossier" required>
        </div>
        <div>
          <label class="font-bold block mb-1">PDF File:</label>
          <input type="text" id="fileInput" list="pdfList" class="w-full border rounded p-2" placeholder="Commencez à taper..." required>
          <datalist id="pdfList"></datalist>
        </div>
        <button type="submit" id="analyzeBtn" class="brand-bg text-white w-full py-2 rounded brand-hover">Analyser PDF</button>
      </form>
      <div id="jsonContainer" class="hidden">
        <h4 class="text-lg font-bold mb-2">📋 JSON extrait</h4>
        <textarea id="jsonPreview" class="w-full h-72 border rounded p-2 font-mono bg-gray-800 text-gray-100" readonly></textarea>
        <button id="confirmImport" class="brand-bg text-white w-full py-2 rounded mt-3 brand-hover">✅ Confirmer Import</button>
      </div>
    </div>
    <div id="loadingOverlay"><div class="loader"></div></div>
  </main>
<script>
// helper
function option(text, value) {
    const o = document.createElement("option");
    o.textContent = text; o.value = value;
    return o;
}

const base = '{{ url_for('pdf.index') }}';

// 1) Providers -> auto-sélection + cascade
fetch(base + "api/providers").then(r => r.json()).then(data => {
    const providerSelect = document.getElementById("providerSelect");
    providerSelect.innerHTML = "";
    if (!data || data.length === 0) {
        providerSelect.appendChild(option("— Aucun provider —", ""));
        return;
    }
    data.forEach(p => providerSelect.appendChild(option(p.name, p.id)));
    const defProv = data.find(p => p.id === 169);
    providerSelect.value = defProv ? defProv.id : data[0].id;
    providerSelect.dispatchEvent(new Event("change"));
});

// 2) Provider change -> Certifications (puis cascade vers Modules)
document.getElementById("providerSelect").addEventListener("change", function () {
    const prov_id = this.value;
    const certSelect = document.getElementById("certSelect");
    const modSelect  = document.getElementById("moduleSelect");

    certSelect.innerHTML = "";
    modSelect.innerHTML  = "";

    if (!prov_id) {
        certSelect.appendChild(option("— Aucune certification —", ""));
        modSelect.appendChild(option("— Aucun module —", ""));
        return;
    }

    fetch(`${base}api/certifications/${prov_id}`).then(r => r.json()).then(data => {
        certSelect.innerHTML = "";
        if (!data || data.length === 0) {
            certSelect.appendChild(option("— Aucune certification —", ""));
            modSelect.appendChild(option("— Aucun module —", ""));
            return;
        }
        data.forEach(c => certSelect.appendChild(option(c.name, c.id)));
        let sel = data[0].id;
        if (Number(prov_id) === 169) {
            const defCert = data.find(c => c.id === 23);
            if (defCert) sel = defCert.id;
        }
        certSelect.value = sel;
        certSelect.dispatchEvent(new Event("change"));
    }).catch(() => {
        certSelect.innerHTML = ""; modSelect.innerHTML = "";
        certSelect.appendChild(option("— Erreur chargement —", ""));
    });
});

// 3) Certification change -> Modules (auto-sélection du 1er)
document.getElementById("certSelect").addEventListener("change", function () {
    const cert_id = this.value;
    const modSelect = document.getElementById("moduleSelect");

    modSelect.innerHTML = "";
    if (!cert_id) {
        modSelect.appendChild(option("— Aucun module —", ""));
        return;
    }

    fetch(`${base}api/modules/${cert_id}`).then(r => r.json()).then(data => {
        modSelect.innerHTML = "";
        if (!data || data.length === 0) {
            modSelect.appendChild(option("— Aucun module —", ""));
            return;
        }
        data.forEach(m => modSelect.appendChild(option(m.name, m.id)));
        modSearch.value = "";
        modSearch.dispatchEvent(new Event('input'));
    }).catch(() => {
        modSelect.appendChild(option("— Erreur chargement —", ""));
    });
});

// 3bis) Recherche dynamique de PDF
const dirInput = document.getElementById("dirInput");
const fileInput = document.getElementById("fileInput");
const pdfList   = document.getElementById("pdfList");

fileInput.addEventListener("input", function() {
    const root = dirInput.value.trim();
    const query = this.value.trim();
    if (!root || query.length === 0) {
        pdfList.innerHTML = "";
        return;
    }
    fetch(`${base}api/search-pdfs?root=${encodeURIComponent(root)}&q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
            pdfList.innerHTML = "";
            data.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p;
                pdfList.appendChild(opt);
            });
        });
});

// 4) Soumission pour analyse PDF
let currentSession = null;
document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("analyzeBtn");
    btn.disabled = true;
    const overlay = document.getElementById("loadingOverlay");
    overlay.classList.add('show');

    try {
        const formData = new FormData();
        formData.append("module_id", document.getElementById("moduleSelect").value);
        const dir = dirInput.value.trim().replace(/\/+$/, "");
        const file = fileInput.value.trim();
        formData.append("file_path", dir ? `${dir}/${file}` : file);
        const res = await fetch(base + "upload-pdf", { method: "POST", body: formData });
        const data = await res.json();
        if (data.status === "ok") {
            currentSession = data.session_id;
            document.getElementById("jsonPreview").value = JSON.stringify(data.json_data, null, 4);
            document.getElementById("jsonContainer").classList.remove("hidden");
        } else {
            alert("Erreur : " + (data.message || "analyse impossible"));
        }
    } catch (err) {
        alert("Erreur réseau : " + err);
    } finally {
        btn.disabled = false;
        overlay.classList.remove('show');
    }
});

// 5) Confirmation import (affiche les bonnes clés de la réponse)
document.getElementById("confirmImport").addEventListener("click", async function() {
    if (!currentSession) {
        alert("Aucune session d’analyse en mémoire. Analyse un PDF d’abord.");
        return;
    }
    const formData = new FormData();
    formData.append("session_id", currentSession);
    const overlay = document.getElementById("loadingOverlay");
    const btn = this;
    btn.disabled = true;
    overlay.classList.add('show');

    try {
        const res = await fetch(base + "import-questions", { method: "POST", body: formData });
        const data = await res.json();
        if (data.status === "ok") {
            alert(`✅ Import terminé : ${data.imported_questions} questions, ${data.imported_answers} réponses`);
        } else {
            alert("❌ Erreur import : " + (data.message || "échec"));
        }
    } catch (err) {
        alert("Erreur réseau : " + err);
    } finally {
        btn.disabled = false;
        overlay.classList.remove('show');
    }
});

const modSearch = document.getElementById('moduleSearch');
const moduleSelect = document.getElementById('moduleSelect');
modSearch.addEventListener('input', function(){
    const term = this.value.toLowerCase();
    Array.from(moduleSelect.options).forEach(o => {
        o.style.display = o.text.toLowerCase().includes(term) ? '' : 'none';
    });
});
</script>
</body>
</html>
