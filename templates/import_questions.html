<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Importer Questions</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family:sans-serif; }
    .panel { display:inline-block; width:45%; vertical-align:top;
             border:1px solid #ccc; border-radius:6px; padding:1em; margin:1%; }
    .field { margin:.5em 0; }
    label { display:block; font-weight:bold; margin-bottom:.2em; }
    select, textarea, button { width:100%; padding:.5em; font-size:1em; }
    #progress { width:100%; background:#eee; border-radius:4px; overflow:hidden; margin-top:1em; }
    #bar { width:0%; height:1em; background:#28a745; transition:width .3s; }
    #log { white-space:pre-wrap; background:#f9f9f9; padding:.5em; height:8em; overflow-y:auto; border:1px solid #ddd; margin-top:.5em; }
    .brand-bg { background-color:#28a745; }
    .brand-hover:hover { background-color:#218838; }
  </style>
</head>
<body class="bg-gray-100">
  <nav class="brand-bg text-white">
    <div class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
      <a href="{{ url_for('home') }}" class="text-2xl font-semibold">ExBoot Laboratory</a>
      <ul class="flex flex-wrap space-x-4 mt-4 sm:mt-0">
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('populate_index') }}">Populate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('dom.index') }}">Import Modules</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('move.index') }}">Move Questions</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reloc.index') }}">Relocate</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.index') }}">PDF Importer</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('pdf.generate_index') }}">PDF Generator</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('quest.index') }}">Manual Import</a></li>
        <li><a class="px-3 py-2 rounded brand-hover" href="{{ url_for('reports') }}">Reports</a></li>
      </ul>
    </div>
  </nav>
  <main class="container mx-auto px-4 mt-8">
  <h1 class="text-2xl font-bold mb-4">Importer des Questions</h1>
  <div class="panel">
    <div class="field">
      <label for="prov">Provider</label>
      <select id="prov"></select>
    </div>
    <div class="field">
      <label for="cert">Certification</label>
      <select id="cert"></select>
    </div>
    <div class="field">
      <label for="mod">Domaine</label>
      <select id="mod"></select>
    </div>
  </div>

  <div class="panel">
    <div class="field">
      <label for="json-input">Collez le JSON des questions</label>
      <textarea id="json-input" rows="12" placeholder='{"questions":[{"text":"Question text","scenario":"none","nature":"qcm","level":"medium","answers":[{"value":"A","isok":1},{"value":"B","isok":0}]}]}'></textarea>
    </div>
    <button id="import-btn">Importer</button>
    <div id="progress"><div id="bar"></div></div>
    <div id="log"></div>
  </div>

<script>
async function loadJSON(url){ const r = await fetch(url); return r.json(); }
function fill(sel, items){ sel.innerHTML=''; items.forEach(i=>{ const o=document.createElement('option'); o.value=i.id; o.text=i.name; sel.appendChild(o); }); }

document.addEventListener('DOMContentLoaded', async()=>{
  const provSel=document.getElementById('prov');
  const certSel=document.getElementById('cert');
  const modSel=document.getElementById('mod');
  const base='{{ url_for('quest.index') }}';
  const provs=await loadJSON(base+'api/providers');
  fill(provSel, provs);
  provSel.value=provs[0]?.id; provSel.dispatchEvent(new Event('change'));

  provSel.addEventListener('change', async()=>{
    const cs=await loadJSON(`${base}api/certifications/${provSel.value}`);
    fill(certSel, cs);
    certSel.value=cs[0]?.id; certSel.dispatchEvent(new Event('change'));
  });

  certSel.addEventListener('change', async()=>{
    const ms=await loadJSON(`${base}api/modules/${certSel.value}`);
    fill(modSel, ms);
  });
});

function parseFlexibleJSON(txt){
  txt = txt.replace(/[‘’]/g, "'").replace(/[“”]/g, '"').trim();
  try{ return JSON.parse(txt); }catch(e){}
  try{ return (new Function('return ('+txt+')'))(); }catch(e){}
  txt = txt.replace(/\bNone\b/g,'null').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false');
  try{ return (new Function('return ('+txt+')'))(); }catch(e){}
  return null;
}

 document.getElementById('import-btn').onclick = async ()=>{
    const moduleId=+document.getElementById('mod').value;
    if(!moduleId) return alert('Module manquant');
    const data = parseFlexibleJSON(document.getElementById('json-input').value);
    if(!data) return alert('JSON invalide');
    const questions=data.questions;
    if(!Array.isArray(questions)) return alert('Format JSON attendu: {"questions":[...] }');
    const total=questions.length;
    const log=document.getElementById('log');
    const bar=document.getElementById('bar');
    log.textContent=''; bar.style.width='0%';
    for(let i=0;i<total;i++){
      const q=questions[i];
      try{
        const res=await fetch(base+'api/questions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({module_id:moduleId, question:q})});
        const j=await res.json();
        if(res.ok) log.textContent+=`✓ [${j.id}]\n`;
        else log.textContent+=`✗ ${j.error}\n`;
      }catch(e){ log.textContent+=`✗ ${e}\n`; }
      bar.style.width=Math.round((i+1)/total*100)+'%';
    }
    alert('Import terminé');
 };
</script>
</main>
</body>
</html>