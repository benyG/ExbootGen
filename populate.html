<!-- templates/populate.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Populate Questions - ExamBoot</title>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-3xl mx-auto p-8 bg-white shadow-xl mt-12 rounded">
    <h1 class="text-4xl font-bold text-center mb-8">Populate Questions</h1>
    
    {% if not is_populating %}
    <!-- Formulaire de sélection -->
    <form id="select-form" method="POST" action="/populate" class="space-y-6">
      <div>
        <label for="provider_id" class="block text-lg font-medium text-gray-700">Provider:</label>
        <select name="provider_id" id="provider_id" class="mt-1 block w-full rounded border-gray-300 shadow-sm">
          {% for provider in providers %}
            <option value="{{ provider[0] }}">{{ provider[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="cert_id" class="block text-lg font-medium text-gray-700">Certification:</label>
        <select name="cert_id" id="cert_id" class="mt-1 block w-full rounded border-gray-300 shadow-sm">
          <!-- Options chargées via AJAX -->
        </select>
      </div>
      <div>
        <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
          Populate
        </button>
      </div>
    </form>
    {% else %}
    <!-- Page de progression -->
    <div class="mb-4">
      <p class="text-xl font-semibold">
        Provider ID: <span class="font-normal">{{ provider_id }}</span>, Certification ID: <span class="font-normal">{{ cert_id }}</span>
      </p>
    </div>
    
    <!-- Affichage des compteurs -->
    <div id="counterDisplay" class="mb-4 p-4 bg-gray-50 border rounded">
      <p class="font-bold text-gray-800">Analyse Certification:</p>
      <p id="analysisResult" class="text-gray-700">En attente...</p>
      <p class="font-bold text-gray-800 mt-2">Domaines traités:</p>
      <p id="domainCounter" class="text-gray-700">0 / 0</p>
      <p class="font-bold text-gray-800 mt-2">Total Questions Importées:</p>
      <p id="questionCounter" class="text-gray-700">0</p>
    </div>
    
    <div class="mb-6 text-center space-x-2">
      <button id="startPopulate" class="px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700 transition">
        Start Population Process
      </button>
      <button id="pausePopulate" class="px-6 py-3 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
        Pause
      </button>
      <button id="resumePopulate" class="px-6 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
        Resume
      </button>
    </div>
    
    <!-- Barre de progression -->
    <div id="progressBar" class="w-full bg-gray-200 rounded-full h-6 mb-6">
      <div id="progressBarFill" class="bg-blue-500 h-6 text-center text-white rounded-full" style="width: 0%;">0%</div>
    </div>
    
    <!-- Zone de log de progression -->
    <div id="progressLog" class="border border-gray-300 p-4 rounded">
      <p class="font-bold text-gray-800 mb-2">Progress:</p>
      <ul id="logList" class="list-disc pl-5 text-gray-700"></ul>
    </div>
    {% endif %}
  </div>
  
  <script>
    $(document).ready(function(){
        // Charger les certifications quand un provider est sélectionné.
        $("#provider_id").change(function(){
            $.post("/populate/get_certifications", { provider_id: $(this).val() }, function(data){
                $("#cert_id").empty();
                $.each(data, function(i, item){
                    $("#cert_id").append($("<option>", { 
                        value: item.id,
                        text : item.name 
                    }));
                });
            }, "json");
        });
        
        // Lancement du processus de population et mise à jour dynamique des logs et compteurs
        $("#startPopulate").click(function(){
            $("#logList").empty();
            $("#progressBarFill").css("width", "0%").text("0%");
            // Réinitialiser les compteurs affichés
            $("#analysisResult").text("En attente...");
            $("#domainCounter").text("0 / 0");
            $("#questionCounter").text("0");
            $.post("/populate/process", {
                provider_id: "{{ provider_id }}",
                cert_id: "{{ cert_id }}"
            }, function(response){
                var logs = response.log;
                var total = logs.length;
                var i = 0;
                if(response.counters) {
                    $("#analysisResult").text(response.counters.analysis);
                    $("#domainCounter").text(response.counters.domainsProcessed + " / " + response.counters.totalDomains);
                    $("#questionCounter").text(response.counters.totalQuestions);
                }
                function displayNextLog() {
                    if (i < total) {
                        $("#logList").append("<li>" + logs[i] + "</li>");
                        var percent = Math.round(((i+1) / total) * 100);
                        $("#progressBarFill").css("width", percent + "%").text(percent + "%");
                        i++;
                        setTimeout(displayNextLog, 500);
                    }
                }
                displayNextLog();
            }, "json");
        });

        // Bouton de pause
        $("#pausePopulate").click(function(){
            $.post("/populate/pause", {}, function(response){
                $("#logList").append("<li>Processus mis en pause.</li>");
            }, "json");
        });

        // Bouton de reprise
        $("#resumePopulate").click(function(){
            $.post("/populate/resume", {}, function(response){
                $("#logList").append("<li>Processus repris.</li>");
            }, "json");
        });
    });
  </script>
</body>
</html>
