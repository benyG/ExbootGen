{
  "schema_version": "0.2.0",
  "lab": {
    "id": "windows-zero-trust-hands-on",
    "title": "Windows 11 Zero Trust Hardening",
    "subtitle": "Configurer, valider et auditer un poste de travail",
    "scenario_md": "Votre √©quipe endpoint vient de recevoir un nouveau lot de postes Windows 11 pour √©quiper un plateau d'analystes SOC. Vous devez finaliser la s√©curisation du premier poste de la s√©rie avant de propager l'image √† l'ensemble du parc.\n\nL'environnement doit respecter les exigences Zero Trust : pare-feu actif sur tous les profils, canal de mises √† jour ma√Ætris√©, et collecte centralis√©e des journaux. Les services d'infrastructure vous ont remis un extrait de journal et attendent votre validation.\n\nAu fil des √©tapes, vous pr√©parerez la configuration locale, analyserez les preuves d'ex√©cution, puis mod√©liserez la topologie cible pour documenter les commandes standard √† appliquer √† chaque composant.",
    "variables": {
      "device_name": { "type": "choice", "choices": ["WS-210", "WS-455", "WS-889"] },
      "site_code": { "type": "choice", "choices": ["EU-WKS", "NA-HQ"] }
    },
    "scoring": { "max_points": 110 },
    "timer": { "mode": "countdown", "seconds": 2700 },
    "assets": [
      {
        "id": "security_snapshot.txt",
        "filename": "security_snapshot.txt",
        "kind": "file",
        "mime": "text/plain",
        "inline": true,
        "content_b64": "TG9nTmFtZT1TZWN1cml0eQpTb3VyY2VOYW1lPU1pY3Jvc29mdCBXaW5kb3dzIHNlY3VyaXR5IGF1ZGl0aW5nLgpFdmVudENvZGU9NzA0NQpFdmVudFR5cGU9NApUeXBlPUluZm9ybWF0aW9uCkNvbXB1dGVyTmFtZT1XUy0yMTAuY29ycC5jb250b3NvLmxvY2FsClRhc2tDYXRlZ29yeT1Ob25lCk9wQ29kZT1JbmZvClJlY29yZE51bWJlcj00MzIxOQpLZXl3b3Jkcz1BdWRpdCBTdWNjZXNzCk1lc3NhZ2U9QSBzZXJ2aWNlIHdhcyBpbnN0YWxsZWQgaW4gdGhlIHN5c3RlbS4KU2VydmljZSBOYW1lOiBQU0VYRVNWQwpTZXJ2aWNlIEZpbGUgTmFtZTogQzpcV2luZG93c1xQU0VYRVNWQy5leGUKU2VydmljZSBUeXBlOiB1c2VyIG1vZGUgc2VydmljZQpTZXJ2aWNlIFN0YXJ0IFR5cGU6IGRlbWFuZCBzdGFydApTZXJ2aWNlIEFjY291bnQ6IExvY2FsU3lzdGVtCgpMb2dOYW1lPU1pY3Jvc29mdC1XaW5kb3dzLVBvd2VyU2hlbGwvT3BlcmF0aW9uYWwKRXZlbnRJRD00MTA0Ck1lc3NhZ2U9Q3JlYXRpbmcgU2NyaXB0YmxvY2sgdGV4dCAoMSBvZiAxKToKcG93ZXJzaGVsbC5leGUgLU5vUCAtV2luZG93U3R5bGUgSGlkZGVuIC1FbmNvZGVkQ29tbWFuZCBTUUJ2QUc0QVpRQmtBQ0FBTlFBd0FEb2dBRXdBYndCaEFHUUFaUUJrQUM0dUxnPT0KVXNlcjogQ09SUFxzdmMuZGVwbG95Cg=="
      }
    ],
    "steps": [
      {
        "id": "enable-firewall",
        "type": "terminal",
        "title": "Activer le pare-feu sur {{device_name}}",
        "instructions_md": "Depuis une console PowerShell √©lev√©e sur **{{device_name}}**, active les trois profils du pare-feu Windows. Utilise l'applet `Set-NetFirewallProfile` pour basculer Domain, Private et Public sur *Enabled*.",
        "terminal": {
          "prompt": "{{device_name}} PS C:\\\>",
          "validators": [
            {
              "kind": "command",
              "match": {
                "program": "powershell",
                "subcommand": ["Set-NetFirewallProfile"],
                "flags": {
                  "required": ["--Profile", "--Enabled"],
                  "aliases": { "-Profile": "--Profile", "-Enabled": "--Enabled" }
                },
                "args": [
                  { "flag": "--Profile", "expect": "Domain,Private,Public" },
                  { "flag": "--Enabled", "expect": "True" }
                ]
              },
              "response": {
                "stdout_template": "Profiles Domain,Private,Public enabled on {{device_name}}\\n",
                "world_patch": [
                  { "op": "set", "path": "windows.devices.{{device_name}}.hostname", "value": "{{device_name}}" },
                  { "op": "set", "path": "windows.devices.{{device_name}}.site_code", "value": "{{site_code}}" },
                  { "op": "set", "path": "windows.devices.{{device_name}}.firewall.enabled", "value": true },
                  { "op": "set", "path": "windows.devices.{{device_name}}.firewall.profiles", "value": ["Domain", "Private", "Public"] }
                ]
              }
            }
          ]
        },
        "points": 20,
        "hints": [
          "L'applet PowerShell attend une liste de profils via `--Profile Domain,Private,Public`.",
          "Assure-toi que `--Enabled True` est pr√©sent pour valider l'√©tape."
        ],
        "transitions": { "on_success": "configure-updates", "on_failure": "#stay" }
      },
      {
        "id": "configure-updates",
        "type": "console_form",
        "title": "D√©finir la politique Windows Update",
        "instructions_md": "Dans le portail Endpoint Manager simul√©, configure la politique de mises √† jour pour **{{device_name}}** : canal *Production*, plage active de 08:00 √† 20:00 et d√©lai de red√©marrage de 2 jours.",
        "form": {
          "model_path": "windows.devices.{{device_name}}.update_policy",
          "schema": {
            "fields": [
              { "key": "ring", "widget": "toggle", "label": "Canal de d√©ploiement", "options": ["Pilote", "Production"], "placeholder": "Choisir le canal" },
              { "key": "active_hours_start", "label": "Heure de d√©but", "placeholder": "08:00" },
              { "key": "active_hours_end", "label": "Heure de fin", "placeholder": "20:00" },
              { "key": "deadline_days", "label": "D√©lai (jours)", "placeholder": "2" }
            ]
          }
        },
        "validators": [
          { "kind": "world", "expect": { "path": "windows.devices.{{device_name}}.update_policy.ring", "equals": "Production" } },
          { "kind": "world", "expect": { "path": "windows.devices.{{device_name}}.update_policy.active_hours_start", "equals": "08:00" } },
          { "kind": "world", "expect": { "path": "windows.devices.{{device_name}}.update_policy.active_hours_end", "equals": "20:00" } },
          { "kind": "world", "expect": { "path": "windows.devices.{{device_name}}.update_policy.deadline_days", "equals": "2" } }
        ],
        "hints": [
          "Commence par s√©lectionner le canal *Production* via le bouton bascule.",
          "Renseigne les heures actives et le d√©lai exactement comme demand√© (08:00 / 20:00 / 2)."
        ],
        "points": 25,
        "transitions": { "on_success": "analyze-logs", "on_failure": "#stay" }
      },
      {
        "id": "analyze-logs",
        "type": "inspect_file",
        "title": "Analyser l'√©v√©nement suspect",
        "instructions_md": "T√©l√©charge l'extrait de journal fourni et identifie le binaire install√© par le compte de service **svc.deploy**. Saisis la r√©ponse (chemin ou nom) dans la zone ci-dessous.",
        "file_ref": "security_snapshot.txt",
        "input": {
          "mode": "answer",
          "placeholder": "Ex: C\\\\Windows\\\\PSEXESVC.exe",
          "prompt": "Quel service ou binaire non autoris√© a √©t√© d√©ploy√© par le compte `svc.deploy` ?"
        },
        "validators": [
          {
            "kind": "expression",
            "expr": "((get('payload')||'').toLowerCase().includes('psexesvc') || (get('payload')||'').toLowerCase().includes('psexec'))",
            "message": "Indique le service PSEXESVC.exe install√© via PsExec."
          }
        ],
        "hints": [
          "Rep√®re l'√©v√©nement 7045 pour conna√Ætre le service install√©.",
          "Le journal PowerShell 4104 r√©v√®le √©galement la commande ex√©cut√©e par svc.deploy."
        ],
        "points": 20,
        "transitions": { "on_success": "design-architecture", "on_failure": "#stay" }
      },
      {
        "id": "design-architecture",
        "type": "architecture",
        "title": "Mod√©liser l'atelier Zero Trust",
        "instructions_md": "Assemble la topologie cible :\n- **DC01** h√©berge la for√™t AD et cr√©e l'UO *Workstations*.\n- **MEMCM** orchestre les clients et force une action d'inventaire mat√©riel.\n- **Poste {{device_name}}** applique son adressage local et pointe vers le contr√¥leur de domaine pour le DNS.\n- **WSUS** publie les correctifs requis pour le site **{{site_code}}**.\n\nAjoute les commandes correspondantes √† chaque composant dans le panneau de droite et relie les flux : DC01 ‚Üí MEMCM, MEMCM ‚Üí Poste, MEMCM ‚Üí WSUS. Ignore le composant leurre.",
        "architecture": {
          "palette_title": "Composants Windows",
          "palette_caption": "Fais glisser uniquement les √©l√©ments utiles. Le composant h√©ritage n'est qu'un leurre.",
          "palette": [
            { "id": "domain_controller", "label": "Contr√¥leur de domaine", "icon": "üõ°Ô∏è", "tags": ["core"] },
            { "id": "config_manager", "label": "Centre de configuration", "icon": "üñ•Ô∏è", "tags": ["management"] },
            { "id": "client", "label": "Poste Windows", "icon": "üíª", "tags": ["endpoint"] },
            { "id": "update_server", "label": "Serveur WSUS", "icon": "üóÑÔ∏è", "tags": ["patch"] },
            { "id": "legacy_gateway", "label": "Passerelle FTP h√©rit√©e", "icon": "üì†", "tags": ["decoy"], "is_decoy": true, "description": "√âl√©ment volontairement hors sujet." }
          ],
          "initial_nodes": [
            { "palette_id": "domain_controller", "label": "DC01", "alias": "dc", "position": { "x": 120, "y": 200 } },
            { "palette_id": "config_manager", "label": "MEMCM", "alias": "cm", "position": { "x": 320, "y": 200 } },
            { "palette_id": "client", "label": "Poste {{device_name}}", "alias": "client", "position": { "x": 320, "y": 60 } },
            { "palette_id": "update_server", "label": "WSUS", "alias": "wsus", "position": { "x": 320, "y": 340 } }
          ],
          "help": "Clique sur les ports lat√©raux pour cr√©er les liens. Utilise le panneau Inspecteur pour saisir les commandes ex√©cut√©es.",
          "world_path": "windows.topology.zero_trust",
          "expected_world": {
            "nodes": [
              { "match": { "label": "DC01", "palette_id": "domain_controller", "config_contains": ["New-ADOrganizationalUnit", "Workstations"] }, "count": 1 },
              { "match": { "label": "MEMCM", "palette_id": "config_manager", "config_contains": ["Invoke-CMClientAction", "Hardware Inventory"] }, "count": 1 },
              { "match": { "label": "Poste {{device_name}}", "palette_id": "client", "config_contains": ["New-NetIPAddress", "Set-DnsClientServerAddress"] }, "count": 1 },
              { "match": { "label": "WSUS", "palette_id": "update_server", "config_contains": ["Install-WindowsFeature", "UpdateServices"] }, "count": 1 }
            ],
            "links": [
              { "from": { "label": "DC01" }, "to": { "label": "MEMCM" }, "count": 1, "bidirectional": true },
              { "from": { "label": "MEMCM" }, "to": { "label": "Poste {{device_name}}" }, "count": 1, "bidirectional": true },
              { "from": { "label": "MEMCM" }, "to": { "label": "WSUS" }, "count": 1, "bidirectional": true }
            ],
            "allow_extra_nodes": false
          }
        },
        "validators": [
          { "kind": "payload", "path": "nodes.length", "equals": 4, "message": "Utilise uniquement les quatre composants attendus." },
          { "kind": "expression", "expr": "Array.isArray(get('payload.nodes')) && get('payload.nodes').every(n => (n.config||'').trim().length > 0)", "message": "Chaque composant doit contenir les commandes appliqu√©es." }
        ],
        "hints": [
          "Le contr√¥leur de domaine doit r√©f√©rencer la cr√©ation de l'UO Workstations.",
          "Sur le poste client, indique l'adresse IP et le serveur DNS via `New-NetIPAddress` et `Set-DnsClientServerAddress`."
        ],
        "points": 30,
        "transitions": { "on_success": "hardening-quiz", "on_failure": "#stay" }
      },
      {
        "id": "hardening-quiz",
        "type": "quiz",
        "title": "Valider la couverture",
        "question_md": "Quelle v√©rification confirmera le plus rapidement que le poste applique bien la politique antimalware Zero Trust ?",
        "choices": [
          { "id": "a", "text": "Ex√©cuter `Get-MpComputerStatus` pour v√©rifier la derni√®re signature Defender." },
          { "id": "b", "text": "Consulter l'observateur d'√©v√©nements pour des erreurs DFS." },
          { "id": "c", "text": "Red√©marrer la machine pour appliquer les strat√©gies de groupe." }
        ],
        "correct": ["a"],
        "hints": ["Pense √† une commande locale offrant un √©tat instantan√© de l'antimalware."],
        "points": 15,
        "transitions": { "on_success": "#end", "on_failure": "#stay" }
      }
    ]
  }
}
